import { Component, Input, OnDestroy } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { Subscription } from 'rxjs';
import { GoodImplementationService } from '../../services/good-implementation.service';
import { BadImplementationService } from '../../services/bad-implementation.service';

@Component({
  selector: 'app-xss',
  imports: [CommonModule, FormsModule],
  templateUrl: './xss.component.html',
  styleUrl: './xss.component.css',
})
export class XSSComponent implements OnDestroy {
  @Input() isGoodImplementation: boolean = false
  showModal: boolean = false
  copiedText: string = ''
  private subscriptions: Subscription[] = []
  private blockedChars = /[<>"'&\/\\`|${}()\[\];:.,+=\-!@#%^*~]/
  
  textInputGood: string = ''
  textInputBad: string = ''

  constructor(
    private goodService: GoodImplementationService,
    private badService: BadImplementationService
  ) {}

  ngOnDestroy() {
    this.subscriptions.forEach(sub => sub.unsubscribe())
  }

  onGoodSubmit() {
    const sub = this.goodService.saveGoodXSSValue(this.textInputGood).subscribe()
    this.subscriptions.push(sub)
  }

  onBadSubmit() {
    const sub = this.badService.saveBadXSSValue(this.textInputBad).subscribe()
    this.subscriptions.push(sub)
  }

  clearInput() {
    if (this.isGoodImplementation) {
      this.textInputGood = '' 
    } else {
      this.textInputBad = ''
    }
  }

  onKeyDown(event: KeyboardEvent) {
    if (this.isGoodImplementation && this.blockedChars.test(event.key)) {
      event.preventDefault()
    }
  }

  onPaste(event: ClipboardEvent) {
    const pastedText = event.clipboardData?.getData('text') || ''
    if (this.blockedChars.test(pastedText)) {
      event.preventDefault()
    } else {
      this.textInputGood = (this.textInputGood + pastedText).slice(0, 50)
    }
  }

  exploitSteps = {
    step1: '<h1 style="color:red;text-align:center;font-size:48px;">SITE DEFACED</h1><p style="color:red;text-align:center;">This website has been compromised by an attacker.</p>',
    step2: '<div style="border:1px solid #ccc;padding:16px;border-radius:8px;max-width:350px;background:white;"><h5 style="margin:0 0 12px;">Session Expired</h5><p style="font-size:13px;color:#666;margin:0 0 8px;">Your session has timed out. Please re-enter your credentials.</p><form><input type="text" placeholder="Username" style="display:block !important;width:100% !important;padding:8px !important;margin-bottom:8px !important;border:1px solid #ccc !important;border-radius:4px !important;box-sizing:border-box !important;font-size:14px !important;"><input type="password" placeholder="Password" style="display:block !important;width:100% !important;padding:8px !important;margin-bottom:12px !important;border:1px solid #ccc !important;border-radius:4px !important;box-sizing:border-box !important;font-size:14px !important;"><button type="button" style="display:block !important;width:100% !important;padding:8px !important;background:#0d6efd !important;color:white !important;border:none !important;border-radius:4px !important;cursor:pointer !important;font-size:14px !important;">Sign In</button></form></div>',
    step3: '<div style="background:#d4edda;border:1px solid #c3e6cb;padding:16px;border-radius:8px;"><h5 style="color:#155724;margin:0 0 8px;">Congratulations! You won a $500 gift card!</h5><p style="color:#155724;font-size:13px;margin:0 0 12px;">Click below to claim your reward before it expires.</p><a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ" style="display:inline-block;padding:8px 20px;background:#28a745;color:white;text-decoration:none;border-radius:4px;">Claim Now</a></div>',
    step4: '<div style="position:fixed !important;top:0 !important;left:0 !important;width:100vw !important;height:100vh !important;background:black !important;z-index:999999 !important;display:flex !important;align-items:center !important;justify-content:center !important;"><h1 style="color:lime !important;font-family:monospace !important;font-size:36px !important;margin:0 !important;">ACCESS DENIED - System Locked</h1></div><style>body > *:not(script):not(style) { opacity: 0 !important; pointer-events: none !important; }</style>'
  }

  toggleModal() {
    this.showModal = !this.showModal
    if (!this.showModal) {
      this.copiedText = ''
    }
  }

  copyToClipboard(text: string, event?: Event) {
    if (event) {
      event.stopPropagation()
    }
    this.copiedText = text
    navigator.clipboard.writeText(text).catch(() => {
      this.copiedText = ''
    });
  }
}
