import { Component, Input, OnDestroy } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { Subscription } from 'rxjs';
import { GoodImplementationService } from '../../services/good-implementation.service';
import { BadImplementationService } from '../../services/bad-implementation.service';

@Component({
  selector: 'app-xss',
  imports: [CommonModule, FormsModule],
  templateUrl: './xss.component.html',
  styleUrl: './xss.component.css',
})
export class XSSComponent implements OnDestroy {
  @Input() isGoodImplementation: boolean = false
  showModal: boolean = false
  copiedText: string = ''
  private subscriptions: Subscription[] = []
  private blockedChars = /[<>"'&\/\\`|${}()\[\];:.,+=\-!@#%^*~]/
  
  textInputGood: string = ''
  textInputBad: string = ''

  constructor(
    private goodService: GoodImplementationService,
    private badService: BadImplementationService
  ) {}

  ngOnDestroy() {
    this.subscriptions.forEach(sub => sub.unsubscribe())
  }

  onGoodSubmit() {
    const sub = this.goodService.saveXSSValue(this.textInputGood).subscribe({
      next: (response) => console.log('XSS value saved successfully:', response),
      error: (error) => console.error('Error saving XSS value:', error),
    })
    this.subscriptions.push(sub)
  }

  onBadSubmit() {

  }

  clearInput() {
    if (this.isGoodImplementation) {
      this.textInputGood = '' 
    } else {
      this.textInputBad = ''
    }
  }

  onKeyDown(event: KeyboardEvent) {
    if (this.isGoodImplementation && this.blockedChars.test(event.key)) {
      event.preventDefault()
    }
  }

  onPaste(event: ClipboardEvent) {
    const pastedText = event.clipboardData?.getData('text') || ''
    if (this.blockedChars.test(pastedText)) {
      event.preventDefault()
    } else {
      this.textInputGood = (this.textInputGood + pastedText).slice(0, 50)
    }
  }

  exploitSteps = {
    step1: "",
    step2: "",
    step3: "",
    step4: ""
  }

  toggleModal() {
    this.showModal = !this.showModal
    if (!this.showModal) {
      this.copiedText = ''
    }
  }

  copyToClipboard(text: string, event?: Event) {
    if (event) {
      event.stopPropagation()
    }
    this.copiedText = text
    navigator.clipboard.writeText(text).catch(() => {
      this.copiedText = ''
    });
  }
}
